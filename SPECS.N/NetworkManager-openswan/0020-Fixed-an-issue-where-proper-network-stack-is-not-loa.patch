From 7559f06152549e0c457d08c67f2d3088b37c6ccf Mon Sep 17 00:00:00 2001
From: Avesh Agarwal <avagarwa@redhat.com>
Date: Tue, 10 Dec 2013 16:56:18 -0500
Subject: [PATCH 20/20] Fixed an issue where proper network stack is not loaded
 unless _stackmanager is run before starting pluto daemon service.

---
 src/nm-openswan-service.c | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/nm-openswan-service.c b/src/nm-openswan-service.c
index af541bd..f6afee5 100644
--- a/src/nm-openswan-service.c
+++ b/src/nm-openswan-service.c
@@ -290,11 +290,19 @@ nm_openswan_start_openswan_binary (NMOPENSWANPlugin *plugin, GError **error)
 		return -1;
 	}
 
-	/*openswan_argv = g_ptr_array_new ();
+	openswan_argv = g_ptr_array_new ();
+	g_ptr_array_add (openswan_argv, (gpointer) "/usr/libexec/ipsec/_stackmanager");
 	g_ptr_array_add (openswan_argv, (gpointer) "start");
 	g_ptr_array_add (openswan_argv, NULL);
 
-        g_ptr_array_free (openswan_argv, TRUE);*/
+	if (!g_spawn_sync (NULL, (char **) openswan_argv->pdata, NULL,
+													0, NULL, NULL, NULL, NULL, NULL, error)) {
+                g_ptr_array_free (openswan_argv, TRUE);
+                g_printf ("pluto _stackmanager failed with error: '%s'\n", (*error)->message);
+                return -1;
+        }
+	g_ptr_array_free (openswan_argv, TRUE);
+
 	openswan_argv = g_ptr_array_new ();
 	g_ptr_array_add (openswan_argv, (gpointer) "/usr/libexec/ipsec/pluto");
 	g_ptr_array_add (openswan_argv, (gpointer) "--config");
-- 
1.8.3.1

