


Name: konversation
Summary: Konversation is a user friendly IRC client for KDE
Summary(zh_CN.UTF-8): Konversation 是一款 KDE 下用户友好 IRC 客户端
Version: 1.1
Release: 1mgc30
License: GPL
Group: Applications/Internet
Group(zh_CN.UTF-8): 应用程序/互联网
URL: http://konversation.kde.org
Source0: http://download.berlios.de/konversation/konversation-1.1.tar.bz2
Source1: konversation.po
Source2: konversation.desktop
Patch1:	konversation-1.1-admin.patch

BuildRoot: /var/tmp/konversation-1.1-1mgc30-buildroot
BuildRequires: kdebase-devel  >= 3.4, desktop-file-utils, gettext
BuildRequires: magic-rpm-config
Requires: kdebase >= 3.4
Prefix: /usr

%description
A simple and easy to use IRC client for KDE with support for
strikeout; multi-channel joins; away / unaway messages;
ignore list functionality; (experimental) support for foreign
language characters; auto-connect to server; optional timestamps
to chat windows; configurable background colors and much more

%description -l zh_CN.UTF-8
一款 KDE 下的简单好用的 IRC 客户端，支持多频道加入、离开/在线消息、忽略列表功能、多国
语言字符(实验中)、自动连接至服务器、聊天窗口时间戳、可配置的背景颜色以及更多功能

%prep
%setup
%patch1 -p1
chmod 777 admin/*

%build
make -f admin/Makefile.common

  CFLAGS="${CFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -grecord-gcc-switches  -m64 -mtune=generic}" ; export CFLAGS ; 
  CXXFLAGS="${CXXFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -grecord-gcc-switches  -m64 -mtune=generic}" ; export CXXFLAGS ; 
  FFLAGS="${FFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -grecord-gcc-switches  -m64 -mtune=generic -I/usr/lib64/gfortran/modules}" ; export FFLAGS ; 
  FCFLAGS="${FCFLAGS:--O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -grecord-gcc-switches  -m64 -mtune=generic -I/usr/lib64/gfortran/modules}" ; export FCFLAGS ; 
  LDFLAGS="${LDFLAGS:--Wl,-z,relro }"; export LDFLAGS; 
  for i in $(find . -name config.guess -o -name config.sub) ; do 
      [ -f /usr/lib/rpm/magic/$(basename $i) ] && /usr/bin/rm -f $i && /usr/bin/cp -fv /usr/lib/rpm/magic/$(basename $i) $i ; 
  done ; 
  ./configure --build=x86_64-magic-linux-gnu --host=x86_64-magic-linux-gnu \
	--program-prefix= \
	--disable-dependency-tracking \
	--prefix=/usr \
	--exec-prefix=/usr \
	--bindir=/usr/bin \
	--sbindir=/usr/sbin \
	--sysconfdir=/etc \
	--datadir=/usr/share \
	--includedir=/usr/include \
	--libdir=/usr/lib64 \
	--libexecdir=/usr/libexec \
	--localstatedir=/var \
	--sharedstatedir=/var/lib \
	--mandir=/usr/share/man \
	--infodir=/usr/share/info
#临时措施
sed -i 's/\/include\/tqt/\/include\/tqt \-lqt\-mt \-ltdecore \-ltdeui \-lX11 \-lDCOP \-lkio/g' konversation/src/Makefile
/usr/bin/make -j16 CFLAGS="$RPM_OPT_FLAGS"


%package debuginfo 
Summary: Debug information for package konversation
Group: Development/Debug
AutoReqProv: 0
%description debuginfo
This package provides debug information for package konversation.
Debug information is useful when developing applications that use this
package or when debugging this package.
%files debuginfo -f debugfiles.list
%defattr(-,root,root)

%install

/usr/bin/rm -rf /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64
/usr/bin/make DESTDIR=/home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64 install

/usr/bin/magic_rpm_clean.sh

# Replace absolute symlinks with relative ones
# 主要是一些帮助文件的 common 符号链接替换
#pushd /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/usr/share/doc/HTML
#for lang in *; do
#  if [ -d $lang ]; then
#    pushd $lang
#    for i in */*; do
#      [ -d $i -a -L $i/common ] && rm -f $i/common && ln -sf ../../en/common $i/common
#    done
#    popd
#  fi
#done
#popd

install -d -m 755 /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/usr/share/locale/zh_CN/LC_MESSAGES/
msgfmt /home/magic/rpmbuild/SOURCES/konversation.po -o /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/usr/share/locale/zh_CN/LC_MESSAGES/konversation.mo

install -D -m 644 /home/magic/rpmbuild/SOURCES/konversation.desktop /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/usr/share/applications/kde/konversation.desktop

# 准备初始化数据
#mkdir -p /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/etc/skel/.kde/share/config
#mkdir -p /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/root/.kde/share/config
# irc 服务器 & channel 地址更新地址列表
#install -m 600 %{SOURCE10} /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/etc/skel/.kde/share/config/konversationrc
#install -m 600 %{SOURCE10} /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64/root/.kde/share/config/konversationrc


%clean
/usr/bin/rm -rf /home/magic/rpmbuild/BUILDROOT/konversation-1.1-1mgc30.x86_64 /home/magic/rpmbuild/BUILD/konversation-1.1

%post
#for D in `cat /etc/passwd | grep ':/home/' | cut -f 6 -d:`; do
#if [ -d $D ];then
#  cp -auf /etc/skel/.kde/share/config/konversationrc $D/.kde/share/config/
#  USRHOME=`ls -la $D | grep "[^\.\.]\.$"`
#  OWNER=`echo $USRHOME | cut -f 3 -d\ `
#  GROUP=`echo $USRHOME | cut -f 4 -d\ `
#  chown -hR ${OWNER}:${GROUP} $D/.kde/share/config
#  chmod 600 $D/.kde/share/config/konversationrc
#fi
#done
#

%postun


%files
%defattr(-,root,root)
%doc AUTHORS COPYING COPYING-DOCS ChangeLog INSTALL README TODO VERSION
/usr/bin/*
/usr/share/applications/kde/konversation.desktop
/usr/share/apps/kconf_update/*
/usr/share/apps/konversation/*
/usr/share/config.kcfg/konversation.kcfg
/usr/share/doc/HTML/en/*
/usr/share/icons/crystalsvg/*/actions/*
/usr/share/icons/hicolor/*/apps/*
/usr/share/locale/*
/usr/share/services/*.protocol

%changelog
* Sat Oct 25 2008 Ni Hui <shuizhuyuanluo@126.com> - 1.1-0.1mgc
- 更新至 1.1(KDE3 告别版本)
- 去除配置文件(移入 magic-kde-config 包)
- 戊子  九月廿七

* Fri Feb 22 2008 Ni Hui <shuizhuyuanluo@126.com> - 1.0.1-3.2mgc
- 添加配置文件
- 戊子  正月十六

* Sat Nov 17 2007 Ni Hui <shuizhuyuanluo@126.com> - 1.0.1-3.1mgc
- rebuild
- 去除多余语言文件

* Wed Aug 8 2007 Ni Hui <shuizhuyuanluo@126.com> - 1.0.1-3mgc
- 修正 common 文件夹的链接关系
- 菜单项中文翻译

* Sat Jul 28 2007 Ni Hui <shuizhuyuanluo@126.com> - 1.0.1-2mgc
- 改善了一点翻译
- 修改 spec 文件，重新建包

* Sun Apr 22 2007 Ni Hui <shuizhuyuanluo@126.com> - 1.0.1-1mgc
- first port to Magiclinux 2.1
已加载插件：aliases, auto-update-debuginfo, changelog, fastestmirror, filter-data, fs-
          : snapshot, keys, list-data, local, merge-conf, post-transaction-
          : actions, priorities, protectbase, ps, puppetverify, refresh-
          : updatesd, remove-with-leaves, rpm-warm-cache, show-leaves, tmprepo,
          : tsflags, upgrade-helper, verify, versionlock
Loading mirror speeds from cached hostfile
错误：Cannot find a valid baseurl for repo: trinity-3.5.13/x86_64
Could not retrieve mirrorlist http://ppa.quickbuild.pearsoncomputing.net/trinity/trinity/rpm/f21/trinity-3.5.13-x86_64.list error was
14: HTTP Error 404 - Not Found : http://www.mirrorservice.org/sites/trinitydesktop.org/trinity/trinity/rpm/f21/trinity-3.5.13-x86_64.list
错误：构建依赖失败：
	kdebase-devel >= 3.4 被 konversation-1.1-1mgc30.x86_64 需要
